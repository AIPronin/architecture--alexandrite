# Мониторинг

## Мотивация

В системе наблюдаются явные проблемы в работе. Их поиск диагностика и устранение занимают продолжительное время.
Для добавления возможности оперативного реагирования на инциденты необходимо подключить и настроить мониторинг.

### Мониторинг в Alexandrite позволит

1. Организовать комплексный анализ состояния системы
2. Быстро диагностировать тип проблемы возникающей в системе
3. Получать и накапливать информацию по состоянию инфраструктуры
4. Наблюдать за работой API в реальном времени
5. Собирать статистику по заказам и анализировать проблемы
6. Быстро реагировать на ошибки

## Выбор подхода к мониторингу

### USE

- Utilization (утилизация) — это среднее время, которое ресурс занят работой. Измеряется в процентах.
- Saturation (насыщенность) — объём работы, которую ресурс не может выполнить и вынужден откладывать (например, в
  очередь), чтобы сохранять работоспособность. Насыщенность можно измерить как длину очереди.
- Errors (ошибки) — количество ошибок.

Подходит для мониторинга производительности и потребления ресурсов

### Четыре золотых сигнала

- Задержка — это время, которое уходит на доставку запроса по сети от отправителя к получателю.
- Трафик — это показатель активности пользователей в вашем приложении. Его можно измерить с помощью любого
  высокоуровневого системного показателя. В веб-приложениях трафик обычно считают как количество HTTP-запросов в
  секунду.
- Ошибки — это частота неудачных запросов. Сюда относятся как явные ошибки (например, ошибки с кодом 500), так и
  неявные — например, статус запроса 200, но контент доставили неправильно.
- Насыщенность — этот параметр показывает, насколько «заполнена» ваша система. Насыщенность напрямую связана с
  показателем использования системы, но иногда её сложно измерить. Сбои могут возникнуть даже тогда, когда система не
  загружена на сто процентов. Поэтому важно определить целевой уровень использования.

Подходит для мониторинга пользовательского опыта

### RED

- Requests Rate — частота запросов,
- Errors — ошибки,
- Duration — длительность.

Подходит для мониторинга работы сервисов

Для компонентов системы подойдут следующие подходы к мониторингу:

| Подход                 | Компонент        | Собираемые метрики                                                        |
|------------------------|------------------|---------------------------------------------------------------------------|
| USE                    | Shop DB, MES DB  | Утилизация, кол-во подключений, кол-во ошибок                             |
|                        | Message Queue    | Утилизация, длина очереди, кол-во ошибок                                  |
|                        | 3d files storage | Скорость чтения с диска, свободное место, кол-во ошибок                   |
| Четыре золотых сигнала | Frontend         | Количество пользователей, частота запросов, кол-во ошибок, время загрузки |
| RED                    | Shop API,        | Кол-во запросов, % ошибок, время выполнения                               |
|                        | MES API          | Кол-во запросов, % ошибок, время выполнения, утилизация                   |
|                        | CRM API          | Кол-во запросов, % ошибок, время выполнения, кол-во заказов в обработке   |

## Список метрик

### Message Queue

| Метрика                                            | Описание                                                    | Теги                  |
|----------------------------------------------------|-------------------------------------------------------------|-----------------------|
| Number of dead-letter-exchange letters in RabbitMQ | Количество сообщений в очереди которое невозможно доставить | queue, error, service |
| Number of message in flight in RabbitMQ            | Кол-во сообщений в очереди в обработке                      | queue                 |

### Shop API

| Метрика                                                 | Описание                                               | Теги                     |
|---------------------------------------------------------|--------------------------------------------------------|--------------------------|
| Number of requests (RPS) for internet shop API          | Кол-во запросов в секунду к API                        | endpoint, method         |
| Number of requests (RPS) per user for internet shop API | Кол-во запросов в секунду к API от одного пользователя | endpoint, method, status |
| Response time (latency) for shop API                    | Время ответа API на запросы                            | endpoint, method         |
| Number of HTTP 500 for shop API                         | Кол-во ошибочных запросов к API                        | endpoint, method         |
| CPU % for shop API                                      | Утилизация CPU для серверов API                        | instance                 |
| Memory Utilisation for shop API                         | Утилизация памяти для серверов API                     | instance                 |

### CRM API

| Метрика                                       | Описание                                               | Теги                     |
|-----------------------------------------------|--------------------------------------------------------|--------------------------|
| Number of requests (RPS) for internet CRM API | Кол-во запросов в секунду к API                        | endpoint, method         |
| Number of requests (RPS) per user for CRM API | Кол-во запросов в секунду к API от одного пользователя | endpoint, method, status |
| Response time (latency) for CRM API           | Время ответа API на запросы                            | endpoint, method         |
| Number of HTTP 500 for CRM API                | Кол-во ошибочных запросов к API                        | endpoint, method         |
| CPU % for CRM API                             | Утилизация CPU для серверов API                        | instance                 |
| Memory Utilisation for CRM API                | Утилизация памяти для серверов API                     | instance                 |

### MES API

| Метрика                                       | Описание                                               | Теги                     |
|-----------------------------------------------|--------------------------------------------------------|--------------------------|
| Number of requests (RPS) for internet MES API | Кол-во запросов в секунду к API                        | endpoint, method         |
| Number of requests (RPS) per user for MES API | Кол-во запросов в секунду к API от одного пользователя | endpoint, method, status |
| Response time (latency) for MES API           | Время ответа API на запросы                            | endpoint, method         |
| Number of HTTP 500 for MES API                | Кол-во ошибочных запросов к API                        | endpoint, method         |
| CPU % for MES API                             | Утилизация CPU для серверов API                        | instance                 |
| Memory Utilisation for MES API                | Утилизация памяти для серверов API                     | instance                 |

### Frontend

| Метрика                             | Описание                                                    | Теги         |
|-------------------------------------|-------------------------------------------------------------|--------------|
| Number of requests (RPS)            | Кол-во запросов в секунду к Frontend                        | url, service |
| Number of requests (RPS) per user   | Кол-во запросов в секунду к Frontend от одного пользователя | url, service |
| Response time (latency) for MES API | Время загрузки страницы                                     | url, service |
| Number of HTTP 200                  | Кол-во успешных запросов                                    | url, service |
| Number of HTTP 500                  | Кол-во ошибочных запросов                                   | url, service |
| Kb tranferred (received)            | Кол-во входящего трафика                                    | url, service |
| Kb provided (sent) for shop API     | Кол-во исходящего трафика                                   | service      |
| Number of simultanious sessions     | Кол-во активных сессий пользователей                        | service      |

### Хранилища данных

| Метрика                             | Описание               | Теги      |
|-------------------------------------|------------------------|-----------|
| Size of S3 storage                  | Размер хранилища       | instance  |


### Shop db

| Метрика                                    | Описание                 | Теги      |
|--------------------------------------------|--------------------------|-----------|
| Memory Utilisation for shop db instance    | Утилизация памяти для БД | instance  |
| Number of connections for shop db instance | Кол-во соединений к БД   |           |
| Size of shop db instance                   | Размер хранилища БД      | instance  |



### MES db

| Метрика                                    | Описание                 | Теги      |
|--------------------------------------------|--------------------------|-----------|
| Memory Utilisation for MES db instance    | Утилизация памяти для БД | instance  |
| Number of connections for MES db instance | Кол-во соединений к БД   |           |
| Size of MES db instance                   | Размер хранилища БД      | instance  |




## План действий
1. Установка ПО
- Установка и настройка Prometheus. Установить отказоустойчивый кластер prometheus из 3х нод и добавить необходимые настройки.
- Установка и настройка Grafana 
2. Организация сбора метрик. 

Требуется установить и настроить экспортеры метрик на всех необходимых компонентах. Для бизнес метрик требуется разработать

| Компонент                | Экспортер                                                   | 
|--------------------------|-------------------------------------------------------------|
| Базы данных              | https://github.com/prometheus-community/postgres_exporter   | 
| RabbitMQ                 | https://github.com/kbudde/rabbitmq_exporter                 | 
| Файловое хранилище       | https://github.com/prometheus/node_exporter                 |  
| Сбор параметров серверов | https://github.com/prometheus/node_exporter                 |  
| MES API                  | https://github.com/prometheus-net/prometheus-net            | 
| Shop API, CRM API        | micrometer                                                  | 

3. Настроить дашборды и алертинг

Настраиваются несколько категорий дашбордов для отображения:
- Показатели системного уровня: для отслеживания показателей утилизации оборудования
- Метрики производительности: для отслеживания показателей работоспособности системных компонентов
- Бизнес-метрики: для отслеживания ключевых показателей эффективности бизнес-процессов

Примеры метрик и настройка оповещений:

| Метрики системного уровня               | Параметры для алертинга          | 
|-----------------------------------------|----------------------------------|
| Загрузка CPU                            | Достижение 80%                   | 
| Загрузка RAM                            | Достижение определенных значений | 
| Заполненность хранилищ данных           | Более 70% заполненности хранилищ |


| Метрики производительности      | Параметры для алертинга                                              | 
|---------------------------------|----------------------------------------------------------------------|
| Время ответа сервиса            | Кол-во запросов выполняющихся дольше определенного времени за период | 
| Доступность API                 | Доступность определенных компонентов и сервисов                      | 
| Кол-во элементов в очереди      | Более определенного кол-ва элементов в очереди                       |


| Бизнес-метрики                        | Параметры для алертинга                                | 
|---------------------------------------|--------------------------------------------------------|
| Кол-во новых заказов за период        | Отсутствие заказов в течении рабочего дня              | 
| Кол-во обработанных заказов за период | Отсутствие обработанных заказов в течении рабочего дня | 
| Кол-во выполненных заказов за период  | Отсутствие выполненных заказов в течении рабочего дня  |
